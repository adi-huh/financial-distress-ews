{% extends "base.html" %}

{% block title %}Companies - Financial Distress EWS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold mb-2">Companies</h1>
            <p class="text-muted">Manage your company database</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCompanyModal">
                <i class="bi bi-plus-circle"></i> Add Company
            </button>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by name or ticker...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Industry</label>
                            <select class="form-select" id="industryFilter">
                                <option value="">All Industries</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Country</label>
                            <select class="form-select" id="countryFilter">
                                <option value="">All Countries</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Companies Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Company List</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Ticker</th>
                                    <th>Industry</th>
                                    <th>Country</th>
                                    <th>Added Date</th>
                                    <th>Risk Level</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="companiesTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Loading companies...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Company Modal -->
<div class="modal fade" id="addCompanyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCompanyForm">
                    <div class="mb-3">
                        <label for="companyName" class="form-label">Company Name *</label>
                        <input type="text" class="form-control" id="companyName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="companyTicker" class="form-label">Ticker Symbol</label>
                        <input type="text" class="form-control" id="companyTicker" name="ticker" placeholder="e.g., AAPL">
                    </div>
                    <div class="mb-3">
                        <label for="companyIndustry" class="form-label">Industry</label>
                        <input type="text" class="form-control" id="companyIndustry" name="industry" placeholder="e.g., Technology">
                    </div>
                    <div class="mb-3">
                        <label for="companyCountry" class="form-label">Country</label>
                        <input type="text" class="form-control" id="companyCountry" name="country" placeholder="e.g., USA">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddCompany()">Add Company</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Company Modal -->
<div class="modal fade" id="editCompanyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCompanyForm">
                    <input type="hidden" id="editCompanyId">
                    <div class="mb-3">
                        <label for="editCompanyName" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="editCompanyName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCompanyTicker" class="form-label">Ticker Symbol</label>
                        <input type="text" class="form-control" id="editCompanyTicker" name="ticker">
                    </div>
                    <div class="mb-3">
                        <label for="editCompanyIndustry" class="form-label">Industry</label>
                        <input type="text" class="form-control" id="editCompanyIndustry" name="industry">
                    </div>
                    <div class="mb-3">
                        <label for="editCompanyCountry" class="form-label">Country</label>
                        <input type="text" class="form-control" id="editCompanyCountry" name="country">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditCompany()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let allCompanies = [];
    const addCompanyModal = new bootstrap.Modal(document.getElementById('addCompanyModal'));
    const editCompanyModal = new bootstrap.Modal(document.getElementById('editCompanyModal'));

    document.addEventListener('DOMContentLoaded', async function() {
        try {
            showLoading();
            await loadCompanies();
            populateFilters();
        } catch (error) {
            console.error('Error loading companies:', error);
        } finally {
            hideLoading();
        }
    });

    async function loadCompanies() {
        try {
            const response = await axios.get('/api/companies?limit=1000');
            allCompanies = response.data.companies;
            displayCompanies(allCompanies);
        } catch (error) {
            console.error('Error loading companies:', error);
            document.getElementById('companiesTable').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error loading companies</td></tr>';
        }
    }

    function displayCompanies(companies) {
        const tbody = document.getElementById('companiesTable');
        
        if (companies.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No companies found</td></tr>';
            return;
        }

        tbody.innerHTML = companies.map(company => `
            <tr>
                <td><strong>${company.name}</strong></td>
                <td>${company.ticker || 'N/A'}</td>
                <td>${company.industry || 'N/A'}</td>
                <td>${company.country || 'N/A'}</td>
                <td>${new Date(company.created_at).toLocaleDateString()}</td>
                <td>
                    <span class="badge ${getRiskBadgeClass(company.risk_score)}">
                        ${getRiskLevel(company.risk_score)}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editCompany(${company.id})">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCompany(${company.id})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function populateFilters() {
        const industries = new Set();
        const countries = new Set();
        
        allCompanies.forEach(company => {
            if (company.industry) industries.add(company.industry);
            if (company.country) countries.add(company.country);
        });
        
        const industrySelect = document.getElementById('industryFilter');
        industries.forEach(industry => {
            const option = document.createElement('option');
            option.value = industry;
            option.textContent = industry;
            industrySelect.appendChild(option);
        });
        
        const countrySelect = document.getElementById('countryFilter');
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            countrySelect.appendChild(option);
        });
    }

    function getRiskLevel(score) {
        if (!score) return 'N/A';
        if (score >= 7) return 'High';
        if (score >= 4) return 'Medium';
        return 'Low';
    }

    function getRiskBadgeClass(score) {
        if (!score) return 'bg-secondary';
        if (score >= 7) return 'bg-danger';
        if (score >= 4) return 'bg-warning';
        return 'bg-success';
    }

    async function submitAddCompany() {
        const form = document.getElementById('addCompanyForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        try {
            showLoading();
            await axios.post('/api/companies', data);
            
            form.reset();
            addCompanyModal.hide();
            await loadCompanies();
            
            alert('Company added successfully!');
        } catch (error) {
            console.error('Error adding company:', error);
            alert('Error adding company: ' + (error.response?.data?.error || error.message));
        } finally {
            hideLoading();
        }
    }

    async function editCompany(companyId) {
        const company = allCompanies.find(c => c.id === companyId);
        if (!company) return;

        document.getElementById('editCompanyId').value = company.id;
        document.getElementById('editCompanyName').value = company.name;
        document.getElementById('editCompanyTicker').value = company.ticker || '';
        document.getElementById('editCompanyIndustry').value = company.industry || '';
        document.getElementById('editCompanyCountry').value = company.country || '';

        editCompanyModal.show();
    }

    async function submitEditCompany() {
        const companyId = document.getElementById('editCompanyId').value;
        const form = document.getElementById('editCompanyForm');
        const formData = new FormData(form);
        
        const data = {
            name: document.getElementById('editCompanyName').value,
            ticker: document.getElementById('editCompanyTicker').value,
            industry: document.getElementById('editCompanyIndustry').value,
            country: document.getElementById('editCompanyCountry').value
        };

        try {
            showLoading();
            await axios.put(`/api/companies/${companyId}`, data);
            
            editCompanyModal.hide();
            await loadCompanies();
            
            alert('Company updated successfully!');
        } catch (error) {
            console.error('Error updating company:', error);
            alert('Error updating company: ' + (error.response?.data?.error || error.message));
        } finally {
            hideLoading();
        }
    }

    async function deleteCompany(companyId) {
        if (!confirm('Are you sure you want to delete this company?')) return;

        try {
            showLoading();
            await axios.delete(`/api/companies/${companyId}`);
            
            await loadCompanies();
            alert('Company deleted successfully!');
        } catch (error) {
            console.error('Error deleting company:', error);
            alert('Error deleting company: ' + (error.response?.data?.error || error.message));
        } finally {
            hideLoading();
        }
    }

    // Search and filter handlers
    document.getElementById('searchInput').addEventListener('input', filterCompanies);
    document.getElementById('industryFilter').addEventListener('change', filterCompanies);
    document.getElementById('countryFilter').addEventListener('change', filterCompanies);

    function filterCompanies() {
        let filtered = allCompanies;
        
        const search = document.getElementById('searchInput').value.toLowerCase();
        if (search) {
            filtered = filtered.filter(c => 
                c.name.toLowerCase().includes(search) || 
                (c.ticker && c.ticker.toLowerCase().includes(search))
            );
        }
        
        const industry = document.getElementById('industryFilter').value;
        if (industry) {
            filtered = filtered.filter(c => c.industry === industry);
        }
        
        const country = document.getElementById('countryFilter').value;
        if (country) {
            filtered = filtered.filter(c => c.country === country);
        }
        
        displayCompanies(filtered);
    }
</script>
{% endblock %}
